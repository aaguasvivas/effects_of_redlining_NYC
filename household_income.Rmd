---
title: "household_income"
author: "Adelson Aguasvivas"
date: "4/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(janitor)
library(sf)
library(rgdal)
library(tidycensus)
library(scales)
library(gt)
library(gridExtra)
library(lemon)
library(rvest)
library(magrittr)
library(leaflet)
library(gganimate)
library(spdplyr)
library(rmapshaper)



```


```{r manhattan-ny1950census, include=FALSE}

# Import Census Tract Data as data.frame Consult
# nhgis0013_ds82_1950_tract_codebook.txt codebook file to determine that column
# B0F001 contains Median Income in 1949. Rename this MedianHHIncome for clarity.
# Will need to figure out what the income variables are called for each new year
# of data you download from the codebook that comes with each NHGIS download.
# Select only MedianHHIncome and GISJOIN variables. GISJOIN is the variable that
# allows you to join the census tract median income data with the shapefile
# data. Also drop census tracts which reported 0 median income

data1950 <- read.csv("raw-data/householdincomedata/1950/nhgis0009_csv/nhgis0009_ds82_1950_tract.csv")%>%
  filter(STATE == "New York" & B0F001 > 0) %>%
  mutate(MedianHHIncome1949 = B0F001) %>%
  select(GISJOIN,MedianHHIncome1949)

# Import Census Tract Shapefile into R as SpatialPolygonsDataFrameFormat (SP Dataframe)
# dsn is location of folder which contains shapefiles, (.proj, .shp etc.)
# layer is the filename of the .shp file inside the
# folder dsn points to. 

tracts1950 <- sf::st_read(dsn = 
                            "raw-data/householdincomedata/1950/nhgis0009_shape/nhgis0009_shapefile_tl2008_us_tract_1950/",
                         layer = "US_tract_1950_conflated")

# *Select New York observations only using NHGISST variable NHGISST should be
# consistent between census years, but you might need to double-check this if
# you try 1960, 1970. *The NHGISST code is 360 for New York because New York's
# FIPS code is 360. Google New York FIPS code for more information about the
# FIPS system. *Need to have spdplyr package loaded to use tidyverse commands on
# SpatialPolygonsDataFrame aka `filter' and 'mutate' *Join the data1950 data
# with the MedianHHIncome variable by 'GISJOIN' so that the tract lines and
# income data are in one object *Subset to Manhattan county, which has FIPS code
# 061 *Can see other NY county fips codes at
# https://simple.wikipedia.org/wiki/List_of_counties_in_New_York

tracts1950 <-
  tracts1950 %>% filter(NHGISST == "360" & COUNTY == "061")%>%
  merge(data1950, "GISJOIN")


# Set projection of tracts dataset to `projection` required by leaflet

tracts1950 <- sf::st_transform(tracts1950,  crs="+init=epsg:4326")

# Condense size of data for faster processing

tracts1950 <- rmapshaper::ms_simplify(tracts1950)

# Set palette color

write_rds(tracts1950, "shiny/household_income/manhattan/1950/household_income_1950.rds")


pal <- colorNumeric("viridis", NULL)

#  Plot the data

leaflet(tracts1950) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(MedianHHIncome1949)) %>%
  addLegend(pal = pal, values = ~MedianHHIncome1949, opacity = 1.0)



```

```{r manhattan-ny1960census, include=FALSE}

####1960 Census Tracts Median Family Income####

## Load data
## Create variable Median Bracket, filter out missing data

tracts1960<-read.csv("raw-data/householdincomedata/1960/nhgis0010_csv/nhgis0010_ds92_1960_tract.csv", 
                     stringsAsFactors = FALSE)%>%
                     mutate(MedianBracket=NA)%>%
                     filter(is.na(B8W001)==FALSE)

## Get column names

Brackets1960<-c(colnames(tracts1960)[11:23])

## Iterate through rows

for(i in 1:nrow(tracts1960)){
  
  ## Create DF with as many rows as families in data, labels are the name of the income bracket
  subDF<-tibble(FakePop=rep(Brackets1960, c(tracts1960[i,11:23])))
  
  ## Calculate median family income
  
  ## Find the middle row of the new dataset, ie the median family and 
  ## store what income bracket they fall into
  out<-unlist(subDF[round(nrow(subDF)/2),1])
  if(nrow(subDF)==0 | length(out)==0){next}
  
  ## Save in tracts1960
  tracts1960$MedianBracket[i]<-out
}

## Convert factors to middle of range

tracts1960Print<-tracts1960%>%
                mutate(MedianIncome=recode(MedianBracket,"B8W001"=500,"B8W002"=1500, "B8W003"=2500,
                                         "B8W004"=3500, "B8W005"=4500, "B8W006"=5500,
                                         "B8W007"=6500, "B8W008"=7500, "B8W009"=8500,
                                         "B8W010"=9500, "B8W011"=12500, "B8W012"=20000,
                                         "B8W013"=25000))
## SaveRDS file
#saveRDS(tracts1960Print, file="~/Downloads/nhgis0017_csv/1960MedianFamilyIncome_CensusTracts.RDS")

tracts1960Print

manhattan_household_income_1960 <- tracts1960Print %>%
  filter(STATE == "New York" & COUNTYA == "61" & !is.na(MedianIncome)) %>%
  select(GISJOIN, MedianIncome)

manhattan_1960_map <- sf::st_read(dsn = "raw-data/householdincomedata/1960/nhgis0010_shape/nhgis0010_shapefile_tl2008_us_tract_1960/",
                        layer = "US_tract_1960_conflated")

manhattan_1960_map <- manhattan_1960_map %>%
  merge(manhattan_household_income_1960, "GISJOIN")

manhattan_1960_map <- sf::st_transform(manhattan_1960_map,  
                                       crs="+init=epsg:4326")

manhattan_1960_map <- rmapshaper::ms_simplify(manhattan_1960_map)

# Set palette color

write_rds(manhattan_1960_map, "shiny/household_income/manhattan/1960/household_income_1960.rds")

pal <- colorNumeric("viridis", NULL)

#  Plot the data

leaflet(manhattan_1960_map) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(MedianIncome)) %>%
  addLegend(pal = pal, values = ~MedianIncome, opacity = 1.0)


```

```{r manhattan-ny1970census, include=FALSE}

#### Median Family Income 1970 Census Tracts####
tracts1970 <- read.csv("raw-data/householdincomedata/1970/nhgis0011_csv/nhgis0011_ds99_1970_tract.csv", 
                       stringsAsFactors = FALSE) %>%
  mutate(MedianBracket=NA) %>%
  filter(is.na(C3T001)==FALSE & C3T001>0)

## Get column names
Brackets1970<-c(colnames(tracts1970)[16:30])
## Iterate through rows
for(i in 1:nrow(tracts1970)){
  
  ## Create DF with as many rows as families
  subDF<-tibble(FakePop=rep(Brackets1970, c(tracts1970[i,16:30])))
  
  ## Calculate median family income
  out<-unlist(subDF[round(nrow(subDF)/2),1])
  if(nrow(subDF)==0 | length(out)==0){next}
  
  ## Save 
  tracts1970$MedianBracket[i]<-out
}

## Convert factors to middle of range
tracts1970Print<-tracts1970%>%
  mutate(MedianIncome=recode(MedianBracket,"C3T001"=500,"C3T002"=1500, "C3T003"=2500,
                             "C3T004"=3500, "C3T005"=4500, "C3T006"=5500,
                             "C3T007"=6500, "C3T008"=7500, "C3T009"=8500,
                             "C3T010"=9500, "C3T011"=11000, "C3T012"=13500,
                             "C3T013"=20000, "C3T014"=37500, "C3T015"=50000))
## SaveRDS file
#saveRDS(tracts1970Print, file="~/Downloads/nhgis0017_csv/1970MedianFamilyIncome_CensusTracts.RDS")

manhattan_household_income_1970 <- tracts1970Print %>%
  filter(STATE == "New York" & COUNTYA == "61" & !is.na(MedianIncome)) %>%
  select(GISJOIN, MedianIncome)

manhattan_1970_map <- sf::st_read(dsn = "raw-data/householdincomedata/1970/nhgis0011_shape/nhgis0011_shapefile_tl2008_us_tract_1970/",
                        layer = "US_tract_1970_conflated")

manhattan_1970_map <- manhattan_1970_map %>%
  merge(manhattan_household_income_1970, "GISJOIN")

manhattan_1970_map <- sf::st_transform(manhattan_1970_map,  
                                       crs="+init=epsg:4326")

manhattan_1970_map <- rmapshaper::ms_simplify(manhattan_1970_map)

# Set palette color

write_rds(manhattan_1970_map, "shiny/household_income/manhattan/1970/household_income_1970.rds")

pal <- colorNumeric("viridis", NULL)

#  Plot the data

leaflet(manhattan_1970_map) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(MedianIncome)) %>%
  addLegend(pal = pal, values = ~MedianIncome, opacity = 1.0)


```

```{r ny1980census, include=FALSE}

# Import Census Tract Data as data.frame Consult
# nhgis0013_ds82_1950_tract_codebook.txt codebook file to determine that column
# B0F001 contains Median Income in 1949. Rename this MedianHHIncome for clarity.
# Will need to figure out what the income variables are called for each new year
# of data you download from the codebook that comes with each NHGIS download.
# Select only MedianHHIncome and GISJOIN variables. GISJOIN is the variable that
# allows you to join the census tract median income data with the shapefile
# data. Also drop census tracts which reported 0 median income

manhattandata1980 <- 
  read.csv("raw-data/householdincomedata/1980/nhgis0012_csv/nhgis0012_ds107_1980_tract.csv") %>%
  filter(STATE == "New York" & DIE001 > 0) %>%
  mutate(MedianHHIncome1979 = DIE001) %>%
  select(GISJOIN, MedianHHIncome1979)

# Import Census Tract Shapefile into R as SpatialPolygonsDataFrameFormat (SP Dataframe)
# dsn is location of folder which contains shapefiles, (.proj, .shp etc.)
# layer is the filename of the .shp file inside the
# folder dsn points to. 

tracts1980 <- sf::st_read(dsn = "raw-data/householdincomedata/1980/nhgis0012_shape/nhgis0012_shapefile_tl2008_us_tract_1980/",
                         layer = "US_tract_1980_conflated")

# *Select New York observations only using NHGISST variable NHGISST should be
# consistent between census years, but you might need to double-check this if
# you try 1960, 1970. *The NHGISST code is 360 for New York because New York's
# FIPS code is 360. Google New York FIPS code for more information about the
# FIPS system. *Need to have spdplyr package loaded to use tidyverse commands on
# SpatialPolygonsDataFrame aka `filter' and 'mutate' *Join the data1950 data
# with the MedianHHIncome variable by 'GISJOIN' so that the tract lines and
# income data are in one object *Subset to Manhattan county, which has FIPS code
# 061 *Can see other NY county fips codes at
# https://simple.wikipedia.org/wiki/List_of_counties_in_New_York

tracts1980 <-
  tracts1980 %>% filter(NHGISST == "360" & COUNTY=="061")%>%
  merge(manhattandata1980, "GISJOIN")


# Set projection of tracts dataset to `projection` required by leaflet

tracts1980 <- sf::st_transform(tracts1980, crs="+init=epsg:4326")

# Condense size of data for faster processing

tracts1980 <- rmapshaper::ms_simplify(tracts1980)

write_rds(tracts1980, "shiny/household_income/manhattan/1980/household_income_1980.rds")

# Set palette color

pal <- colorNumeric("viridis", NULL)

#  Plot the data

leaflet(tracts1980) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(MedianHHIncome1979)) %>%
  addLegend(pal = pal, values = ~MedianHHIncome1979, opacity = 1.0)



```

```{r ny1990census, include=FALSE}

# Import Census Tract Data as data.frame Consult
# nhgis0013_ds82_1950_tract_codebook.txt codebook file to determine that column
# B0F001 contains Median Income in 1949. Rename this MedianHHIncome for clarity.
# Will need to figure out what the income variables are called for each new year
# of data you download from the codebook that comes with each NHGIS download.
# Select only MedianHHIncome and GISJOIN variables. GISJOIN is the variable that
# allows you to join the census tract median income data with the shapefile
# data. Also drop census tracts which reported 0 median income

data1990 <- read.csv("raw-data/householdincomedata/1990/nhgis0013_csv/nhgis0013_ds123_1990_tract.csv")%>%
  filter(STATE == "New York" & E4U001 > 0)%>%
  mutate(MedianHHIncome1989 = E4U001)%>%
  select(GISJOIN,MedianHHIncome1989)

# Import Census Tract Shapefile into R as SpatialPolygonsDataFrameFormat (SP Dataframe)
# dsn is location of folder which contains shapefiles, (.proj, .shp etc.)
# layer is the filename of the .shp file inside the
# folder dsn points to. 

tracts1990 <- sf::st_read(dsn = "raw-data/householdincomedata/1990/nhgis0013_shape/nhgis0013_shapefile_tl2008_us_tract_1990/",
                         layer = "US_tract_1990_conflated")

# *Select New York observations only using NHGISST variable NHGISST should be
# consistent between census years, but you might need to double-check this if
# you try 1960, 1970. *The NHGISST code is 360 for New York because New York's
# FIPS code is 360. Google New York FIPS code for more information about the
# FIPS system. *Need to have spdplyr package loaded to use tidyverse commands on
# SpatialPolygonsDataFrame aka `filter' and 'mutate' *Join the data1950 data
# with the MedianHHIncome variable by 'GISJOIN' so that the tract lines and
# income data are in one object *Subset to Manhattan county, which has FIPS code
# 061 *Can see other NY county fips codes at
# https://simple.wikipedia.org/wiki/List_of_counties_in_New_York

tracts1990 <-
  tracts1990 %>% filter(NHGISST == "360" & COUNTY=="061")%>%
  merge(data1990, "GISJOIN")


# Set projection of tracts dataset to `projection` required by leaflet

tracts1990 <- sf::st_transform(tracts1990,  crs="+init=epsg:4326")

# Condense size of data for faster processing

tracts1990 <- rmapshaper::ms_simplify(tracts1990)

write_rds(tracts1990, "shiny/household_income/manhattan/1990/household_income_1990.rds")


# Set palette color

pal <- colorNumeric("viridis", NULL)

#  Plot the data

leaflet(tracts1990) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(MedianHHIncome1989)) %>%
  addLegend(pal = pal, values = ~MedianHHIncome1989, opacity = 1.0)



```

```{r manhattan-ny2000census, include=FALSE}

# Import Census Tract Data as data.frame Consult
# nhgis0013_ds82_1950_tract_codebook.txt codebook file to determine that column
# B0F001 contains Median Income in 1949. Rename this MedianHHIncome for clarity.
# Will need to figure out what the income variables are called for each new year
# of data you download from the codebook that comes with each NHGIS download.
# Select only MedianHHIncome and GISJOIN variables. GISJOIN is the variable that
# allows you to join the census tract median income data with the shapefile
# data. Also drop census tracts which reported 0 median income

data2000 <- read.csv("raw-data/householdincomedata/2000/nhgis0014_csv/nhgis0014_ds151_2000_tract.csv")%>%
  filter(STATE == "New York" & GMY001 > 0)%>%
  mutate(MedianHHIncome1999 = GMY001)%>%
  select(GISJOIN,MedianHHIncome1999)

# Import Census Tract Shapefile into R as SpatialPolygonsDataFrameFormat (SP Dataframe)
# dsn is location of folder which contains shapefiles, (.proj, .shp etc.)
# layer is the filename of the .shp file inside the
# folder dsn points to. 

tracts2000 <- sf::st_read(dsn = "raw-data/householdincomedata/2000/nhgis0014_shape/nhgis0014_shapefile_tl2008_us_tract_2000/",
                         layer = "US_tract_2000_conflated")

# *Select New York observations only using NHGISST variable NHGISST should be
# consistent between census years, but you might need to double-check this if
# you try 1960, 1970. *The NHGISST code is 360 for New York because New York's
# FIPS code is 360. Google New York FIPS code for more information about the
# FIPS system. *Need to have spdplyr package loaded to use tidyverse commands on
# SpatialPolygonsDataFrame aka `filter' and 'mutate' *Join the data1950 data
# with the MedianHHIncome variable by 'GISJOIN' so that the tract lines and
# income data are in one object *Subset to Manhattan county, which has FIPS code
# 061 *Can see other NY county fips codes at
# https://simple.wikipedia.org/wiki/List_of_counties_in_New_York

tracts2000 <-
  tracts2000 %>% filter(NHGISST == "360" & COUNTY=="061")%>%
  merge(data2000, "GISJOIN")


# Set projection of tracts dataset to `projection` required by leaflet

tracts2000 <-sf::st_transform(tracts2000,  crs="+init=epsg:4326")

# Condense size of data for faster processing

tracts2000 <- rmapshaper::ms_simplify(tracts2000)

write_rds(tracts2000, "shiny/household_income/manhattan/2000/household_income_2000.rds")


# Set palette color

pal <- colorNumeric("viridis", NULL)

#  Plot the data


leaflet(tracts2000) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(MedianHHIncome1999)) %>%
  addLegend(pal = pal, values = ~MedianHHIncome1999, opacity = 1.0)



```

```{r ny2010census, include=FALSE}

# Import Census Tract Data as data.frame Consult
# nhgis0013_ds82_1950_tract_codebook.txt codebook file to determine that column
# B0F001 contains Median Income in 1949. Rename this MedianHHIncome for clarity.
# Will need to figure out what the income variables are called for each new year
# of data you download from the codebook that comes with each NHGIS download.
# Select only MedianHHIncome and GISJOIN variables. GISJOIN is the variable that
# allows you to join the census tract median income data with the shapefile
# data. Also drop census tracts which reported 0 median income

data2010 <- read.csv("raw-data/householdincomedata/2010/nhgis0015_csv/nhgis0015_ds176_20105_2010_tract.csv")%>%
  filter(STATE == "New York" & JOIM001 > 0)%>%
  mutate(MedianHHIncome2010 = JOIM001)%>%
  select(GISJOIN,MedianHHIncome2010)

# Import Census Tract Shapefile into R as SpatialPolygonsDataFrameFormat (SP Dataframe)
# dsn is location of folder which contains shapefiles, (.proj, .shp etc.)
# layer is the filename of the .shp file inside the
# folder dsn points to. 

tracts2010 <- sf::st_read(dsn = "raw-data/householdincomedata/2010/nhgis0015_shape/nhgis0015_shapefile_tl2010_us_tract_2010/",
                         layer = "US_tract_2010")

# *Select New York observations only using NHGISST variable NHGISST should be
# consistent between census years, but you might need to double-check this if
# you try 1960, 1970. *The NHGISST code is 360 for New York because New York's
# FIPS code is 360. Google New York FIPS code for more information about the
# FIPS system. *Need to have spdplyr package loaded to use tidyverse commands on
# SpatialPolygonsDataFrame aka `filter' and 'mutate' *Join the data1950 data
# with the MedianHHIncome variable by 'GISJOIN' so that the tract lines and
# income data are in one object *Subset to Manhattan county, which has FIPS code
# 061 *Can see other NY county fips codes at
# https://simple.wikipedia.org/wiki/List_of_counties_in_New_York

tracts2010 <-
  tracts2010 %>% filter(STATEFP10 == "36" & COUNTYFP10=="061")%>%
  merge(data2010, "GISJOIN")

# Set projection of tracts dataset to `projection` required by leaflet

tracts2010 <-sf::st_transform(tracts2010,  crs="+init=epsg:4326")

# Condense size of data for faster processing

tracts2010 <- rmapshaper::ms_simplify(tracts2010)

write_rds(tracts2010, "shiny/household_income/manhattan/2010/household_income_2010.rds")


# Set palette color

pal <- colorNumeric("viridis", NULL)

#  Plot the data

leaflet(tracts2010) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(MedianHHIncome2010)) %>%
  addLegend(pal = pal, values = ~MedianHHIncome2010, opacity = 1.0)


```